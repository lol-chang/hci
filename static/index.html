<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>여행 플랜 뷰어</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }

    .top-bar {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .plans-tabs {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .plan-tab {
      padding: 8px 16px;
      border-radius: 8px;
      border: 1px solid #ccc;
      background: #fff;
      cursor: pointer;
      user-select: none;
      font-size: 14px;
      white-space: nowrap;
    }

    .plan-tab.active {
      border-color: #004b7a;
      background: #004b7a;
      color: #fff;
      font-weight: 600;
    }

    .plan-tab.disabled {
      opacity: 0.35;
      cursor: default;
      pointer-events: none;
    }

    .plan-tab.drag-over {
      border-style: dashed;
    }

    .hint {
      font-size: 11px;
      color: #888;
      margin-top: 4px;
      margin-bottom: 6px;
    }

    .layout {
      display: grid;
      grid-template-columns: 320px 80px 1fr;
      gap: 16px;
      height: calc(100vh - 130px);
      min-height: 480px;
    }

    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto 400px;
        height: auto;
      }
    }

    .day-places {
      background: #fff;
      border-radius: 10px;
      padding: 14px 14px 16px;
      overflow-y: auto;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .student-search {
      display: flex;
      gap: 6px;
      align-items: center;
      margin-bottom: 4px;
      flex-wrap: wrap;
    }

    .student-search label {
      font-size: 12px;
      color: #444;
    }

    .student-search input {
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      min-width: 110px;
      font-size: 13px;
    }

    .student-search button {
      padding: 6px 10px;
      border-radius: 6px;
      border: none;
      background: #004b7a;
      color: #fff;
      cursor: pointer;
      font-weight: 600;
      font-size: 12px;
    }

    .student-search input.error {
      border-color: #c62828;
      background: #ffebee;
    }

    .error-text {
      font-size: 11px;
      color: #c62828;
      margin-top: -2px;
    }

    .day-title {
      font-weight: 700;
      font-size: 15px;
      margin-top: 4px;
    }

    .user-label {
      font-size: 11px;
      color: #666;
      margin-bottom: 4px;
    }

    .places-empty {
      font-size: 13px;
      color: #777;
      margin-top: 4px;
    }

    .places-list {
      margin-top: 4px;
    }

    .place-card {
      display: grid;
      grid-template-columns: 40px 1fr;
      gap: 8px;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
      margin-bottom: 10px;
      align-items: flex-start;
    }

    .place-number {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #005f85;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: 700;
      font-size: 14px;
    }

    .place-name {
      font-weight: 600;
      margin-bottom: 4px;
      font-size: 14px;
    }

    .place-desc {
      font-size: 12px;
      color: #555;
      line-height: 1.4;
    }

    .days-column {
      display: flex;
      flex-direction: column;
      gap: 8px;
      justify-content: flex-start;
      margin-top: 40px;
    }

    .day-btn {
      padding: 14px 8px;
      border-radius: 8px;
      border: 1px solid #ccc;
      background: #fff;
      text-align: center;
      cursor: pointer;
      font-weight: 500;
      font-size: 13px;
    }

    .day-btn.active {
      background: #005f85;
      color: #fff;
      border-color: #005f85;
    }

    #map {
      width: 100%;
      height: 100%;
      border-radius: 10px;
      background: #0b5272;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    }

    @media (max-width: 900px) {
      .days-column { flex-direction: row; margin-top: 10px; }
      .day-btn { flex: 1; }
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <div class="plans-tabs" id="planTabs">
      <div class="plan-tab" data-plan-index="0" draggable="true">플랜 1</div>
      <div class="plan-tab" data-plan-index="1" draggable="true">플랜 2</div>
      <div class="plan-tab" data-plan-index="2" draggable="true">플랜 3</div>
    </div>
  </div>

  <div class="hint">
    학번 입력 → [검색] → 플랜1/2/3 중 하나 선택해서 Day별 일정과 지도 확인
  </div>

  <div class="layout">
    <div class="day-places">
      <div class="student-search">
        <label for="studentId">학번</label>
        <input id="studentId" type="text" value="20251234" placeholder="예: 20251234" />
        <button id="loadBtn">검색</button>
      </div>
      <div id="studentError" class="error-text" style="display:none;"></div>

      <div class="user-label" id="userLabel"></div>
      <div class="day-title" id="dayTitle">학번을 입력하고 [검색]을 눌러주세요.</div>
      <div id="placesContainer" class="places-list"></div>
    </div>

    <div class="days-column" id="daysColumn"></div>

    <div id="map"></div>
  </div>

  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBxKFWeh8kFjMS3EBvpfXJs7ffrxWL953M&callback=initMap"
    async defer
  ></script>

  <script>
    const API_ENDPOINT = "/plans/by-student";
    let map, markers = [], polyline = null;
    let plansData = null, normalizedPlans = {}, planOrder = [];
    let currentPlanIndex = null, currentDayKey = null;

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 37.75, lng: 128.9 },
        zoom: 11
      });
      setupUIEvents();
    }

    function setupUIEvents() {
      const loadBtn = document.getElementById("loadBtn");
      const planTabs = document.getElementById("planTabs");
      loadBtn.addEventListener("click", loadPlans);

      planTabs.addEventListener("click", (e) => {
        const tab = e.target.closest(".plan-tab");
        if (!tab || tab.classList.contains("disabled")) return;
        const idx = Number(tab.dataset.planIndex);
        if (!getPlanKeyByIndex(idx)) return;
        setActivePlanByIndex(idx);
      });
    }

    async function loadPlans() {
      const input = document.getElementById("studentId");
      const errorBox = document.getElementById("studentError");
      const studentId = input.value.trim();
      input.classList.remove("error");
      errorBox.style.display = "none";

      if (!studentId) {
        input.classList.add("error");
        errorBox.textContent = "학번을 입력해주세요.";
        errorBox.style.display = "block";
        resetView("학번을 입력해주세요.");
        return;
      }

      try {
        const res = await fetch(API_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ student_id: studentId })
        });
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.detail || "플랜을 불러오지 못했습니다.");
        }
        const data = await res.json();
        plansData = data;
        normalizedPlans = data.plans || {};
        planOrder = Array.isArray(data.plan_order) && data.plan_order.length
          ? data.plan_order : ["popularity", "personalized", "hybrid"];

        document.getElementById("userLabel").textContent =
          `${data.name || ""} (${data.student_id || studentId}) / user_id: ${data.user_id || "-"}`;
        updateTabsAvailability();
        const firstIdx = findFirstAvailablePlanIndex();
        if (firstIdx === null) throw new Error("사용 가능한 플랜이 없습니다.");
        currentPlanIndex = firstIdx;
        currentDayKey = getFirstDayKeyByIndex(firstIdx);
        setActivePlanByIndex(firstIdx);
      } catch (err) {
        input.classList.add("error");
        errorBox.textContent = err.message;
        errorBox.style.display = "block";
        resetView(err.message);
      }
    }

    function getPlanKeyByIndex(index) {
      if (!planOrder || index < 0 || index >= planOrder.length) return null;
      const key = planOrder[index];
      return normalizedPlans[key] ? key : null;
    }
    function findFirstAvailablePlanIndex() {
      for (let i = 0; i < 3; i++) if (getPlanKeyByIndex(i)) return i;
      return null;
    }
    function getFirstDayKeyByIndex(index) {
      const key = getPlanKeyByIndex(index);
      const days = normalizedPlans[key]?.days || {};
      return Object.keys(days)[0] || null;
    }
    function updateTabsAvailability() {
      document.querySelectorAll(".plan-tab").forEach((tab, idx) => {
        const key = getPlanKeyByIndex(idx);
        if (!key) tab.classList.add("disabled");
        else tab.classList.remove("disabled");
      });
    }

    function setActivePlanByIndex(index) {
      const key = getPlanKeyByIndex(index);
      if (!key) return;
      currentPlanIndex = index;
      currentDayKey = getFirstDayKeyByIndex(index);
      document.querySelectorAll(".plan-tab").forEach((t, i) =>
        t.classList.toggle("active", i === index)
      );
      renderPlanAndDay();
    }

    function resetView(msg) {
      document.getElementById("userLabel").textContent = "";
      document.getElementById("dayTitle").textContent = msg || "학번을 입력하고 [검색]을 눌러주세요.";
      document.getElementById("placesContainer").innerHTML = "";
      document.getElementById("daysColumn").innerHTML = "";
      document.querySelectorAll(".plan-tab").forEach(t => t.classList.remove("active"));
      clearMap();
    }

    function renderPlanAndDay() {
      const planKey = getPlanKeyByIndex(currentPlanIndex);
      const plan = normalizedPlans[planKey];
      const days = plan?.days || {};
      const dayKeys = Object.keys(days);
      const placesContainer = document.getElementById("placesContainer");
      const daysColumn = document.getElementById("daysColumn");
      const dayTitleEl = document.getElementById("dayTitle");

      placesContainer.innerHTML = "";
      daysColumn.innerHTML = "";

      if (!dayKeys.length) {
        dayTitleEl.textContent = `플랜 ${currentPlanIndex + 1} / 일정 없음`;
        clearMap();
        return;
      }

      if (!currentDayKey || !dayKeys.includes(currentDayKey))
        currentDayKey = dayKeys[0];

      dayKeys.forEach((dk) => {
        const btn = document.createElement("div");
        btn.className = "day-btn" + (dk === currentDayKey ? " active" : "");
        btn.textContent = dk;
        btn.onclick = () => {
          currentDayKey = dk;
          renderPlanAndDay();
        };
        daysColumn.appendChild(btn);
      });

      const places = days[currentDayKey];
      dayTitleEl.textContent = `플랜 ${currentPlanIndex + 1} / ${currentDayKey}`;
      if (!places?.length) {
        placesContainer.innerHTML = "<div class='places-empty'>이 날짜의 일정이 없습니다.</div>";
        clearMap();
        return;
      }

      places.forEach((p, i) => {
        const card = document.createElement("div");
        card.className = "place-card";
        card.innerHTML = `
          <div class="place-number">${i + 1}</div>
          <div>
            <div class="place-name">${p.name || "장소"}</div>
            <div class="place-desc">${p.description || ""}</div>
          </div>`;
        placesContainer.appendChild(card);
      });
      renderMap(places);
    }

    function clearMap() {
      markers.forEach(m => m.setMap(null));
      markers = [];
      if (polyline) polyline.setMap(null);
    }

    function renderMap(places) {
      clearMap();
      if (!places?.length) return;
      const bounds = new google.maps.LatLngBounds();
      const path = [];
      places.forEach((p, i) => {
        const lat = +p.lat, lng = +p.lng;
        if (isNaN(lat) || isNaN(lng)) return;
        const pos = { lat, lng };
        const marker = new google.maps.Marker({ position: pos, map, label: `${i + 1}` });
        markers.push(marker);
        bounds.extend(pos);
        path.push(pos);
      });
      if (path.length)
        polyline = new google.maps.Polyline({ path, map, strokeOpacity: 0.9, strokeWeight: 4 });
      map.fitBounds(bounds);
    }
  </script>
</body>
</html>
